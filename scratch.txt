-- #############################
-- CREATE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_CreatePlayerEvent;

DELIMITER //
CREATE PROCEDURE sp_CreatePlayerEvent(
    IN e_eventID INT, 
    IN e_playerID INT,
    IN e_inningsPlayed INT,
    IN e_salaryPaid INT,
    OUT e_newID INT)
BEGIN
    INSERT INTO PlayerEvents (eventID, playerID, inningsPlayed, salaryPaid) 
    VALUES (e_eventID, e_playerID, e_inningsPlayed, e_salaryPaid);

    -- Store the ID of the last inserted row
    SELECT LAST_INSERT_ID() INTO e_newID;
    -- Display the ID of the last inserted ticket holder.
    SELECT LAST_INSERT_ID() AS 'new_id';

    -- Example of how to get the ID of the newly created person:
        -- CALL sp_CreatePlayerEvent(1, 2, 7, 120000, @new_id);
        -- SELECT @new_id AS 'New PlayerEvent ID';
END //
DELIMITER ;

-- #############################
-- UPDATE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_UpdatePlayerEvent;
DELIMITER //

CREATE PROCEDURE sp_UpdatePlayerEvent (
  IN p_eventID INT,
  IN p_playerID INT,
  IN p_newEventID INT,
  IN p_newPlayerID INT,
  IN p_inningsPlayed INT,
  IN p_salaryPaid INT
)
BEGIN
  DECLARE v_innings INT;
  DECLARE v_salary INT;

  -- Fetch existing data to preserve if NULLs passed
  SELECT inningsPlayed, salaryPaid
    INTO v_innings, v_salary
  FROM PlayerEvents
  WHERE eventID = p_eventID AND playerID = p_playerID;

  SET v_innings = COALESCE(p_inningsPlayed, v_innings);
  SET v_salary  = COALESCE(p_salaryPaid, v_salary);

  START TRANSACTION;
    -- Delete old row
    DELETE FROM PlayerEvents
    WHERE eventID = p_eventID AND playerID = p_playerID;

    -- Insert new row with new key and preserved/updated data
    INSERT INTO PlayerEvents (eventID, playerID, inningsPlayed, salaryPaid)
    VALUES (p_newEventID, p_newPlayerID, v_innings, v_salary);
  COMMIT;

  SELECT 1 AS rows_affected, 'Updated' AS message;
END//

DELIMITER ;

-- #############################
-- DELETE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_DeletePlayerEvent;

DELIMITER //
CREATE PROCEDURE sp_DeletePlayerEvent(IN e_eventID INT, IN e_playerID INT)
BEGIN
    DECLARE error_message VARCHAR(255); 

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    START TRANSACTION;
        -- Deleting corresponding row from PlayerEvents table
        DELETE FROM PlayerEvents WHERE eventID = e_eventID AND playerID = e_playerID;

        -- ROW_COUNT() returns the number of rows affected by the preceding statement.
        IF ROW_COUNT() = 0 THEN
            set error_message = CONCAT('No matching record found in PlayerEvents for eventID: ', e_eventID);
            -- Trigger custom error, invoke EXIT HANDLER
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = error_message;
        END IF;

    COMMIT;

END //
DELIMITER ;

app.post('/player-events/create', async function (req, res) {
    try {
        // Parse frontend form information
        const { eventID, playerID, inningsPlayed, salaryPaid } = req.body;

        const clean = v => (Number.isNaN(v) ? null : v);
        // Create and execute our queries
        // Using parameterized queries (Prevents SQL injection attacks)
        const [results] = await db.query(
            `CALL sp_CreatePlayerEvent(?, ?, ?, ?, @new_id);`,
            [clean(eventID), clean(playerID), clean(inningsPlayed), clean(salaryPaid)]
        );

        // Store ID of last inserted row
        let newID = null;

        // flatten all resultsets and find the one with new_id
        for (const set of results) {
            if (Array.isArray(set) && set[0] && set[0].new_id !== undefined) {
                newID = set[0].new_id;
                break;
            }
        }

        console.log(`Created PlayerEvent with ID: ${newID}`);

        // Send success status to frontend
        res.status(200).json({ message: 'PlayerEvent created successfully' });
    } catch (error) {
        console.error('Error executing queries:', error);
        // Send a generic error message to the browser
        res.status(500).send(
            'An error occurred while executing the database queries.'
        );
    }
});

app.put('/player-events/update/:eventID/:playerID', async function (req, res) {
    try {
        const { eventID, playerID } = req.params;
        const { newEventID, newPlayerID, inningsPlayed, salaryPaid } = req.body;

        const query1 = 'CALL sp_UpdatePlayerEvent(?, ?, ?, ?, ?, ?);';
        const query2 = 'SELECT eventID, playerID, inningsPlayed, salaryPaid FROM PlayerEvents WHERE eventID = ? AND playerID = ?;';

        await db.query(query1, [eventID, playerID, newEventID, newPlayerID, inningsPlayed, salaryPaid]);

        const [[rows]] = await db.query(query2, [newEventID, newPlayerID]);

        console.log(
            `UPDATE PlayerEvents. ID: ${rows.eventID}${rows.playerID}`
        );

        res.status(200).json({ message: 'PlayerEvent updated successfully' });
    } catch (error) {
        console.error('Error executing queries:', error);
        res.status(500).send('An error occurred while executing the database queries.');
    }
});

app.delete('/player-events/:eventID/:playerID', async function (req, res) {
    try {
        // Parse frontend form information
        const eventID = req.params.eventID
        const playerID = req.params.playerID

        // Create and execute our query
        // Using parameterized queries (Prevents SQL injection attacks)
        const query1 = `CALL sp_DeletePlayerEvent(?, ?);`;
        await db.query(query1, [eventID, playerID]);

        console.log(`DELETE PlayerEvents. ID: ${eventID}${playerID}`);
        return res.sendStatus(204);
    } catch (error) {
        console.error('Error executing queries:', error);
        // Send a generic error message to the browser
        res.status(500).json({ error: 'Failed to delete player event' });
    }
});

import '../App.css';
import { MdEdit, MdDelete } from "react-icons/md";

const PlayerEventRow = ({ playerEvent, onEdit, onDelete }) => {
    return (
        <tr>
            {Object.values(playerEvent).map((value, index) => (
                <td key={index}>{value}</td>
            ))}
            <td>
                <MdEdit onClick={e => {e.preventDefault(); onEdit(playerEvent);}} id="edit" />
                <MdDelete onClick={e => {e.preventDefault(); onDelete(playerEvent.eventID, playerEvent.playerID);}} id="delete" />
            </td>
        </tr>
    );
};

export default PlayerEventRow;

import { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import PlayerEventRow from "../components/PlayerEventRow.jsx";

function ViewPlayerEventsPage({ backendURL, setPlayerEventToEdit, setPlayerToEdit, setEventToEdit }) {
    const [events, setEvents] = useState([]);
    const [players, setPlayers] = useState([]);
    const [playerEvents, setPlayerEvents] = useState([]);

    const navigate = useNavigate();

    const columnAliases = {
        eventID: "Event ID",
        playerID: "Player ID",
        inningsPlayed: "Innings Played",
        salaryPaid: "Salary Paid",
        fName: "First Name",
        lName: "Last Name",
        teamName: "Team Name",
        eventStart: "Event Start"
    };

    const getData = async () => {
        try {
            const [playerEventsRes, eventsRes, playersRes] = await Promise.all([
                fetch(`${backendURL}/player-events`),
                fetch(`${backendURL}/events`),
                fetch(`${backendURL}/players`)
            ]);

            const eventsData = await eventsRes.json();
            const playersData = await playersRes.json();
            const playerEventsData = await playerEventsRes.json();

            setPlayerEvents(playerEventsData.playerEvents || playerEventsData);
            setEvents(eventsData.events || eventsData);
            setPlayers(playersData.players || playersData);
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    };

    useEffect(() => {
        getData();
    }, []);

    const onCreate = async () => {
        setEventToEdit(events);
        setPlayerToEdit(players);
        navigate("/player-events/create");
    };

    const onEdit = async playerEventToEdit => {
        setEventToEdit(events);
        setPlayerToEdit(players);
        setPlayerEventToEdit(playerEventToEdit);
        navigate("/player-events/update");
    };

    const onDelete = async (eventID, playerID) => {
        const response = await fetch(`${backendURL}/player-events/${eventID}/${playerID}`, { method: 'DELETE' });
        if (response.status === 204) {
            getData();
        } else {
            console.error(`Failed to delete player event with id = ${eventID}${playerID}, status code = ${response.status}`)
        }
    }

    return (
        <>
            <h2>List of Player Events</h2>

            <table>
                <thead>
                    <tr>
                        {playerEvents.length > 0 && Object.keys(playerEvents[0]).map((header, index) => (
                            <th key={index}>
                                {columnAliases[header] || header}
                            </th>
                        ))}
                        <th>Edit/Delete</th>
                    </tr>
                </thead>

                <tbody>
                    {playerEvents.map((playerEvent, index) => (
                        <PlayerEventRow key={index} playerEvent={playerEvent} onEdit={onEdit} onDelete={onDelete} />
                    ))}
                </tbody>
            </table>
            <button onClick={onCreate}>Create Player Event</button>
        </>
    );
}

export default ViewPlayerEventsPage;
