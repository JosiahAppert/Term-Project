-- #############################
-- CREATE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_CreatePlayerEvent;

DELIMITER //
CREATE PROCEDURE sp_CreatePlayerEvent(
    IN e_eventID INT, 
    IN e_playerID INT,
    IN e_inningsPlayed INT,
    IN e_salary INT,
    OUT e_newID INT)
BEGIN
    INSERT INTO PlayerEvents (eventID, playerID, inningsPlayed, salary) 
    VALUES (e_eventID, e_playerID, e_inningsPlayed, e_salary);

    -- Store the ID of the last inserted row
    SELECT CONCAT(e_eventID,e_playerID) INTO e_newID;
    -- Display the ID of the last inserted ticket holder.
    SELECT CONCAT(e_eventID,e_playerID) AS 'new_id';

    -- Example of how to get the ID of the newly created person:
        -- CALL sp_CreatePlayerEvent(1, 2, 7, 120000, @new_id);
        -- SELECT @new_id AS 'New PlayerEvent ID';
END //
DELIMITER ;

-- #############################
-- UPDATE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_UpdatePlayerEvent;

DELIMITER //
CREATE PROCEDURE sp_UpdatePlayerEvent(IN e_eventID INT, IN e_playerID INT, IN e_inningsPlayed INT, IN e_salary INT)

BEGIN
    UPDATE PlayerEvents SET inningsPlayed = e_inningsPlayed, salary = e_salary WHERE eventID = e_eventID AND playerID = e_playerID; 
END //
DELIMITER ;

-- #############################
-- DELETE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_DeletePlayerEvent;

DELIMITER //
CREATE PROCEDURE sp_DeletePlayerEvent(IN e_eventID INT, IN e_playerID INT)
BEGIN
    DECLARE error_message VARCHAR(255); 

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    START TRANSACTION;
        -- Deleting corresponding row from PlayerEvents table
        DELETE FROM PlayerEvents WHERE eventID = e_eventID AND playerID = e_playerID;

        -- ROW_COUNT() returns the number of rows affected by the preceding statement.
        IF ROW_COUNT() = 0 THEN
            set error_message = CONCAT('No matching record found in PlayerEvents for eventID: ', e_eventID);
            -- Trigger custom error, invoke EXIT HANDLER
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = error_message;
        END IF;

    COMMIT;

END //
DELIMITER ;

app.post('/player-events/create', async function (req, res) {
    try {
        // Parse frontend form information
        const { eventID, playerID, inningsPlayed, salary } = req.body;

        // Create and execute our queries
        // Using parameterized queries (Prevents SQL injection attacks)
        const query1 = `CALL sp_CreatePlayerEvent(?, ?, ?, ?, @new_id);`;

        // Store ID of last inserted row
        const [[[rows]]] = await db.query(query1, [
            eventID,
            playerID,
            inningsPlayed,
            salary,
        ]);

        console.log(`CREATE PlayerEvents. ID: ${rows.new_id} ` +
            `eventID+playerID: ${eventID}${playerID}`
        );

        // Send success status to frontend
        res.status(200).json({ message: 'PlayerEvent created successfully' });
    } catch (error) {
        console.error('Error executing queries:', error);
        // Send a generic error message to the browser
        res.status(500).send(
            'An error occurred while executing the database queries.'
        );
    }
});

app.put('/player-events/update/:eventID/:playerID', async function (req, res) {
    try {
        const eventID = req.params.eventID;
        const playerID = req.params.playerID

        const { eventID, playerID, inningsPlayed, salary } = req.body;

        const query1 = 'CALL sp_UpdatePlayerEvent(?, ?, ?, ?);';
        const query2 = 'SELECT eventID, playerID, inningsPlayed, salary FROM PlayerEvents WHERE eventID = ? AND playerID = ?;';

        await db.query(query1, [eventID, playerID, inningsPlayed, salary]);

        const [[rows]] = await db.query(query2, [eventID, playerID]);

        console.log(
            `UPDATE PlayerEvents. ID: ${rows.eventID}${rows.playerID}`
        );

        res.status(200).json({ message: 'PlayerEvent updated successfully' });
    } catch (error) {
        console.error('Error executing queries:', error);
        res.status(500).send('An error occurred while executing the database queries.');
    }
});

app.delete('/player-events/:eventID/:playerID', async function (req, res) {
    try {
        // Parse frontend form information
        const eventID = req.params.eventID
        const playerID = req.params.playerID

        // Create and execute our query
        // Using parameterized queries (Prevents SQL injection attacks)
        const query1 = `CALL sp_DeletePlayerEvent(?, ?);`;
        await db.query(query1, [eventID, playerID]);

        console.log(`DELETE PlayerEvents. ID: ${eventID}${playerID}`);
        return res.sendStatus(204);
    } catch (error) {
        console.error('Error executing queries:', error);
        // Send a generic error message to the browser
        res.status(500).json({ error: 'Failed to delete player event' });
    }
});

import '../App.css';
import { MdEdit, MdDelete } from "react-icons/md";

const PlayerEventRow = ({ playerEvent, onEdit, onDelete }) => {
    return (
        <tr>
            {Object.values(playerEvent).map((value, index) => (
                <td key={index}>{value}</td>
            ))}
            <td>
                <MdEdit onClick={e => {e.preventDefault(); onEdit(playerEvent);}} id="edit" />
                <MdDelete onClick={e => {e.preventDefault(); onDelete(playerEvent.eventID, playerEvent.playerID);}} id="delete" />
            </td>
        </tr>
    );
};

export default PlayerEventRow;