-- #############################
-- CREATE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_CreatePlayerEvent;

DELIMITER //
CREATE PROCEDURE sp_CreatePlayerEvent(
    IN e_eventID INT, 
    IN e_playerID INT,
    IN e_inningsPlayed INT,
    IN e_salary INT,
    OUT e_eventID INT,
    OUT e_playerID INT)
BEGIN
    INSERT INTO PlayerEvents (eventID, playerID, inningsPlayed, salary) 
    VALUES (e_eventID, e_playerID, e_inningsPlayed, e_salary);

    -- Store the ID of the last inserted row
    SELECT LAST_INSERT_ID() into e_eventID;
    -- Display the ID of the last inserted ticket holder.
    SELECT LAST_INSERT_ID() AS 'new_id';

    -- Example of how to get the ID of the newly created person:
        -- CALL sp_CreatePlayerEvent('Theresa', 'Evans', tevans@gmail.com, 5555555555, @new_id);
        -- SELECT @new_id AS 'New TicketHolder ID';
END //
DELIMITER ;

-- #############################
-- UPDATE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_UpdateTicketHolder;

DELIMITER //
CREATE PROCEDURE sp_UpdateTicketHolder(IN e_eventID INT, IN e_eventID VARCHAR(50), IN e_playerID VARCHAR(50), IN e_inningsPlayed VARCHAR(100), IN e_salary VARCHAR(20))

BEGIN
    UPDATE PlayerEvents SET eventID = e_eventID, playerID = e_playerID, inningsPlayed = e_inningsPlayed, salary = e_salary WHERE ticketHolderID = e_eventID; 
END //
DELIMITER ;

-- #############################
-- DELETE PlayerEvents
-- #############################
DROP PROCEDURE IF EXISTS sp_DeleteTicketHolder;

DELIMITER //
CREATE PROCEDURE sp_DeleteTicketHolder(IN e_eventID INT)
BEGIN
    DECLARE error_message VARCHAR(255); 

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;

    START TRANSACTION;
        -- Deleting corresponding row from PlayerEvents table
        DELETE FROM PlayerEvents WHERE ticketHolderID = e_eventID;

        -- ROW_COUNT() returns the number of rows affected by the preceding statement.
        IF ROW_COUNT() = 0 THEN
            set error_message = CONCAT('No matching record found in PlayerEvents for ticketHolderID: ', e_eventID);
            -- Trigger custom error, invoke EXIT HANDLER
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = error_message;
        END IF;

    COMMIT;

END //
DELIMITER ;

app.put('/ticket-holders/update/:id', async function (req, res) {
    try {
        const ticketHolderID = req.params.id;
        const { eventID, playerID, inningsPlayed, salary } = req.body;

        const query1 = 'CALL sp_UpdateTicketHolder(?, ?, ?, ?, ?);';
        const query2 = 'SELECT ticketHolderID, eventID, playerID, inningsPlayed, salary FROM PlayerEvents WHERE ticketHolderID = ?;';

        await db.query(query1, [ticketHolderID, eventID, playerID, inningsPlayed, salary]);

        const [[rows]] = await db.query(query2, [ticketHolderID]);

        console.log(
            `UPDATE PlayerEvents. ID: ${ticketHolderID} Name: ${rows.eventID} ${rows.playerID}`
        );

        res.status(200).json({ message: 'TicketHolder updated successfully' });
    } catch (error) {
        console.error('Error executing queries:', error);
        res.status(500).send('An error occurred while executing the database queries.');
    }
});

app.delete('/ticket-holders/:id', async function (req, res) {
    try {
        // Parse frontend form information
        const ticketHolderID = req.params.id

        // Create and execute our query
        // Using parameterized queries (Prevents SQL injection attacks)
        const query1 = `CALL sp_DeleteTicketHolder(?);`;
        await db.query(query1, [ticketHolderID]);

        console.log(`DELETE PlayerEvents. ID: ${ticketHolderID}`);
        return res.sendStatus(204);
    } catch (error) {
        console.error('Error executing queries:', error);
        // Send a generic error message to the browser
        res.status(500).json({ error: 'Failed to delete ticket holder' });
    }
});

import '../App.css';
import { MdEdit, MdDelete } from "react-icons/md";

const TicketHolderRow = ({ ticketHolder, onEdit, onDelete }) => {
    return (
        <tr>
            {Object.values(ticketHolder).map((value, index) => (
                <td key={index}>{value}</td>
            ))}
            <td>
                <MdEdit onClick={e => {e.preventDefault(); onEdit(ticketHolder);}} id="edit" />
                <MdDelete onClick={e => {e.preventDefault(); onDelete(ticketHolder.ticketHolderID);}} id="delete" />
            </td>
        </tr>
    );
};

export default TicketHolderRow;